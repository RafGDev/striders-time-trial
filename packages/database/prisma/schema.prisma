generator client {
    provider     = "prisma-client"
    output       = "../src/generated/prisma"
    moduleFormat = "cjs"
}

datasource db {
    provider = "postgresql"
}

model User {
    id                   String         @id @default(uuid())
    name                 String         @unique
    email                String?        @unique
    avatarUrl            String?
    stravaId             String?        @unique
    stravaAccessToken    String?
    stravaRefreshToken   String?
    stravaTokenExpiresAt DateTime?
    googleId             String?        @unique
    timeTrials           TimeTrial[]
    memberships          ClubMember[]
    refreshTokens        RefreshToken[]
    createdAt            DateTime       @default(now())

    @@map("users")
}

model RefreshToken {
    id        String   @id @default(uuid())
    token     String   @unique
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    expiresAt DateTime
    createdAt DateTime @default(now())

    @@index([userId])
    @@map("refresh_tokens")
}

model Club {
    id              String       @id @default(uuid())
    name            String
    inviteCode      String       @unique
    adminInviteCode String       @unique
    members         ClubMember[]
    events          Event[]
    createdAt       DateTime     @default(now())
    updatedAt       DateTime     @updatedAt

    @@map("clubs")
}

model ClubMember {
    id       String   @id @default(uuid())
    role     String   @default("member") // "admin", "member"
    userId   String
    user     User     @relation(fields: [userId], references: [id])
    clubId   String
    club     Club     @relation(fields: [clubId], references: [id])
    joinedAt DateTime @default(now())

    @@unique([userId, clubId])
    @@map("club_members")
}

model Course {
    id         String  @id @default(uuid())
    name       String  @unique
    distanceKm Float
    events     Event[]

    @@map("courses")
}

model Event {
    id         String      @id @default(uuid())
    date       DateTime
    courseId   String
    course     Course      @relation(fields: [courseId], references: [id])
    clubId     String
    club       Club        @relation(fields: [clubId], references: [id])
    timeTrials TimeTrial[]

    @@map("events")
}

model TimeTrial {
    id        String   @id @default(uuid())
    timeMs    Int
    createdAt DateTime @default(now())
    userId    String
    user      User     @relation(fields: [userId], references: [id])
    eventId   String
    event     Event    @relation(fields: [eventId], references: [id])

    @@map("time_trials")
}
